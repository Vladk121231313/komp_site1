{% extends "base.html" %}
{% load static %}

{% block title %}–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ | –ö–æ–º–ø—å—é—Ç–µ—Ä—ã{% endblock title %}

{% block content %}
    <div class="container my-5">
        {% if query %}
            <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è: "{{ query }}"</h1>
            <p class="lead text-muted">–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {{ products.count }}</p>
        {% else %}
            <h1>–í–µ—Å—å –∫–∞—Ç–∞–ª–æ–≥</h1>
        {% endif %}
        <hr>
        
       <div class="row">
        {# --- 1. –°–ê–ô–î–ë–ê–† –° –§–ò–õ–¨–¢–†–ê–ú–ò --- #}
        <div class="col-lg-3 mb-4">
            <div class="card shadow-sm p-3">
                
                {# –§–ò–õ–¨–¢–† –ü–û –¶–ï–ù–ï #}
                <h5 class="card-title mt-2">–¶–µ–Ω–∞ (‚ÇΩ)</h5>
                <div class="mb-3">
                    <label class="small text-muted">–û—Ç</label>
                    <input type="number" id="price-min" class="form-control form-control-sm filter-input" value="0">
                </div>
                <div class="mb-3">
                    <label class="small text-muted">–î–æ</label>
                    <input type="number" id="price-max" class="form-control form-control-sm filter-input" value="1000000">
                </div>

                <hr>

                {# ‚≠êÔ∏è –ù–û–í–û–ï: –§–ò–õ–¨–¢–† –ü–û –ö–ê–¢–ï–ì–û–†–ò–Ø–ú ‚≠êÔ∏è #}
                <h5 class="card-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h5>
                <div class="mb-3" id="category-filters">
                    {# –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∏–∑ view #}
                    {% for cat in categories %}
                    <div class="form-check">
                        {# value –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å slug –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ #}
                        <input class="form-check-input category-checkbox" type="checkbox" value="{{ cat.slug }}" id="cat-{{ cat.slug }}">
                        <label class="form-check-label" for="cat-{{ cat.slug }}">
                            {{ cat.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>

                <button id="apply-filters-btn" class="btn btn-sm btn-primary mt-2 w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button id="reset-filters-btn" class="btn btn-sm btn-outline-secondary mt-2 w-100">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
        
            {# –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ –î–õ–Ø –¢–û–í–ê–†–û–í (9 –ö–û–õ–û–ù–û–ö) #}
            <div class="col-lg-9">
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5" id="product-list-container">
                    {# ‚≠êÔ∏è –í–ù–ò–ú–ê–ù–ò–ï: –ò–∑–º–µ–Ω—è–µ–º row-cols-lg-4 –Ω–∞ row-cols-lg-3, —á—Ç–æ–±—ã —Ç–æ–≤–∞—Ä—ã –∑–∞–Ω–∏–º–∞–ª–∏ 9 –∫–æ–ª–æ–Ω–æ–∫ #}
                    {% for product in products %}
                    <div class="col product-card" 
                        data-price="{{ product.price|floatformat:0 }}"
                        data-category="{{ product.category.slug }}" 
                        id="product-{{ product.slug }}">
                        
                        <div class="card h-100 shadow-sm border-0 position-relative"> 
                            
                            {# –°–¢–ê–¢–£–° –°–ö–õ–ê–î–ê –¢–ï–ü–ï–†–¨ –í–ù–£–¢–†–ò –ö–ê–†–¢–û–ß–ö–ò #}
                            <div class="position-absolute top-0 start-0 p-2" style="z-index: 5;">
                                {% if product.stock > 0 %}
                                    <span class="badge bg-success">–í –Ω–∞–ª–∏—á–∏–∏: {{ product.stock }}</span>
                                {% else %}
                                    <span class="badge bg-danger">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                                {% endif %}
                            </div>

                            <a href="{% url 'catalog:product_detail' category_slug=product.category.slug product_slug=product.slug %}">
                                <img src="{{ product.image.url }}" class="card-img-top p-3" alt="{{ product.name }}" style="height: 180px; object-fit: contain;">
                            </a>
                            
                            <div class="card-body d-flex flex-column">        
                                <h5 class="card-title text-truncate" title="{{ product.name }}">
                                    <a href="{% url 'catalog:product_detail' category_slug=product.category.slug product_slug=product.slug %}" class="text-decoration-none text-dark">{{ product.name }}</a>
                                </h5>
                                <p class="card-text text-muted small mb-1">
                                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ product.category.name }}
                                </p>
                                <p class="card-text text-muted small mb-3">
                                    –ì–∞—Ä–∞–Ω—Ç–∏—è: {{ product.warranty_months }} –º–µ—Å.
                                </p>
                                
                                <div class="mt-auto pt-2"> 
                                    <p class="fw-bold fs-5 text-primary mb-2">
                                        {{product.price|floatformat:0}} ‚ÇΩ
                                    </p>
                                
                                    {% if user.is_authenticated %}
                                        <div id="cart-status-{{ product.slug }}">
                                            {% if product.slug in items_in_cart_slugs %}
                                                <button class="btn btn-success w-100" disabled>‚úÖ –í –∫–æ—Ä–∑–∏–Ω–µ</button>
                                                <a href="{% url 'orders:cart_detail' %}" class="btn btn-outline-secondary btn-sm w-100 mt-1">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É</a>
                                            {% else %}
                                                <form action="{% url 'orders:add_to_cart' category_slug=product.category.slug product_slug=product.slug %}" 
                                                    method="post" 
                                                    class="add-to-cart-form-catalog"
                                                    data-product-slug="{{ product.slug }}"> 
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-primary w-100 add-btn-catalog" {% if product.stock <= 0 %}disabled{% endif %}>
                                                        üõí –î–æ–±–∞–≤–∏—Ç—å
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <a class="btn btn-outline-primary w-100">–í–æ–π—Ç–∏ –∏ –∫—É–ø–∏—Ç—å</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {# –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –ü–û–°–õ–ï –¶–ò–ö–õ–ê (–µ–≥–æ –∏—â–µ—Ç –≤–∞—à JS) #}
                    <div id="no-products-msg" style="display: none;" class="text-center my-5">
                        <h3>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üîç</h3>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤.</p>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <style>
        .text-limit-2-lines {
            display: -webkit-box;
            -webkit-line-clamp: 2; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ 2 —Å—Ç—Ä–æ–∫–∏ */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 2.4em; /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –≤—ã—Å–æ—Ç—É –±–ª–æ–∫–∞ —Ç–µ–∫—Å—Ç–∞ */
            line-clamp: 2;
            display: block;
        }
        .card-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-body {
            padding: 1rem;
        }
        .card-body h5, .card-body p {
            margin-bottom: 0.5rem; 
        }
        
    </style>
{% endblock content %}

{% block custom_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- ‚≠êÔ∏è –§–†–û–ù–¢–ï–ù–î-–§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û –¶–ï–ù–ï ‚≠êÔ∏è ---
        const applyButton = document.getElementById('apply-filters-btn');
        const resetButton = document.getElementById('reset-filters-btn');
        const priceMinInput = document.getElementById('price-min');
        const priceMaxInput = document.getElementById('price-max');
        const categoryCheckboxes = document.querySelectorAll('.category-checkbox'); 
        const productCards = document.querySelectorAll('.product-card'); 
        const noProductsMsg = document.getElementById('no-products-msg');

        // –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞
        const initialMinPrice = priceMinInput.value;
        const initialMaxPrice = priceMaxInput.value;

        // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function applyFilters() {
            // 1. –°—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const minPrice = parseInt(priceMinInput.value) || 0;
            const maxPrice = parseInt(priceMaxInput.value) || Infinity;

            const selectedCategories = Array.from(categoryCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            let visibleCount = 0;

            // 2. –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤
            productCards.forEach(card => {
                const productPrice = parseInt(card.dataset.price);
                const productCategory = card.dataset.category;

                // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                const isPriceMatch = productPrice >= minPrice && productPrice <= maxPrice;
                const isCategoryMatch = selectedCategories.length === 0 || selectedCategories.includes(productCategory);
                // 4. –°–∫—Ä—ã—Ç–∏–µ –∏–ª–∏ –ø–æ–∫–∞–∑ –∫–∞—Ä—Ç–æ—á–∫–∏
                if (isPriceMatch && isCategoryMatch) {
                    card.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
                    visibleCount++;
                } else {
                    card.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º
                }
            });
            
            if (visibleCount === 0) {
            noProductsMsg.style.display = 'block';
            } else {
                noProductsMsg.style.display = 'none';
            }   

            console.log(`–ü–æ–∫–∞–∑–∞–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: ${visibleCount}`);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function resetFilters() {
            priceMinInput.value = initialMinPrice;
            priceMaxInput.value = initialMaxPrice;
            categoryCheckboxes.forEach(cb => cb.checked = false);
            window.history.pushState({}, document.title, window.location.pathname);
            applyFilters();
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryParam = urlParams.get('category'); // –ü–æ–ª—É—á–∞–µ–º ?category=...

            if (categoryParam) {
                // –ò—â–µ–º —á–µ–∫–±–æ–∫—Å —Å —Ç–∞–∫–∏–º value –∏ —Å—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫—É
                const targetCheckbox = document.querySelector(`.category-checkbox[value="${categoryParam}"]`);
                if (targetCheckbox) {
                    targetCheckbox.checked = true;
                }
            }
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–∞–ª–æ—á–µ–∫
            applyFilters();
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        if (applyButton) {
            applyButton.addEventListener('click', applyFilters);
        }
        if (resetButton) {
            resetButton.addEventListener('click', resetFilters);
        }
        
        checkUrlParams();
        

        // --- –í–ê–®–ê –°–£–©–ï–°–¢–í–£–Æ–©–ê–Ø AJAX –õ–û–ì–ò–ö–ê ---
        document.querySelectorAll('.add-to-cart-form-catalog').forEach(form => {
            // ... (–í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ AJAX –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É) ...
            form.addEventListener('submit', function(e) {
                e.preventDefault(); 
                const url = form.action;
                const formData = new FormData(form);
                const button = form.querySelector('.add-btn-catalog');
                
                
                const productSlug = form.getAttribute('data-product-slug');

                const originalText = button.innerHTML;
                button.innerHTML = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
                button.disabled = true;

                const csrfToken = formData.get('csrfmiddlewaretoken');

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (productSlug) {
                        const container = document.getElementById('cart-status-' + productSlug);
                        if (container) {
                            container.innerHTML = `
                                <button class="btn btn-success w-100" disabled>
                                    ‚úÖ –í –∫–æ—Ä–∑–∏–Ω–µ
                                </button>
                                <a href="{% url 'orders:cart_detail' %}" class="btn btn-outline-secondary w-100 mt-1">–ü–µ—Ä–µ–π—Ç–∏</a>
                            `;
                        }
                    }
                    
                    const cartQuantityDisplay = document.getElementById('cart-quantity-display'); 
                    if (cartQuantityDisplay && data.cart_total_quantity > 0) {
                        cartQuantityDisplay.innerHTML = `(${data.cart_total_quantity})`;
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ AJAX:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
            });
        });
    });
</script>
{% endblock custom_js %}