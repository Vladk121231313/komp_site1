{% extends "base.html" %}
{% load static %}

{% block title %}–î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞: {{ product.name }}{% endblock title %}

{% block content %}
    <div class="container mt-5">
        <div class="row">
            
            <div class="col-md-6">
                <img src="{{ product.image.url }}" class="img-fluid border rounded" alt="{{ product.name }}">
            </div>

            <div class="col-md-6"> 
                <h1>{{ product.name }}</h1>
                <hr>
                
                <p class="lead text-muted">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: {{ product.manufacturer.name }}</p> 
                
                <h2>{{ product.price|floatformat:2 }} —Ä—É–±.</h2>
                <p>–ì–∞—Ä–∞–Ω—Ç–∏—è: **{{ product.warranty_months }} –º–µ—Å—è—Ü–µ–≤**</p>
                
                {# ‚≠êÔ∏è –õ–û–ì–ò–ö–ê –ö–ù–û–ü–ö–ò –ö–û–†–ó–ò–ù–´ #}
                <div id="cart-status-container">
                    
                    {% if product.slug in items_in_cart_slugs %}
                        {# üü¢ –°–û–°–¢–û–Ø–ù–ò–ï 1: –¢–û–í–ê–† –£–ñ–ï –í –ö–û–†–ó–ò–ù–ï #}
                       <button class="btn btn-success w-100" disabled id="in-cart-btn-{{ product.slug }}">
                            ‚úÖ –í –∫–æ—Ä–∑–∏–Ω–µ
                        </button>
                        <a href="{% url 'orders:cart_detail' %}" class="btn btn-outline-secondary w-100 mt-1">–ü–µ—Ä–µ–π—Ç–∏</a>
                    {% else %}
                        {# üî¥ –°–û–°–¢–û–Ø–ù–ò–ï 2: –§–û–†–ú–ê –î–õ–Ø AJAX –î–û–ë–ê–í–õ–ï–ù–ò–Ø #}
                        <form action="{% url 'orders:add_to_cart' category_slug=product.category.slug product_slug=product.slug %}" method="post" id="add-to-cart-form">
                            {% csrf_token %}
                            <input type="hidden" name="quantity" value="1">
                            <input type="hidden" name="update" value="False">
                            
                            {% if user.is_authenticated %}
                                {# üí° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–π —Ç–µ–≥ <form> –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π ID! #}
                                <button type="submit" class="btn btn-primary btn-lg w-100" id="add-btn">
                                    –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                                </button>
                            {% else %}
                                {# –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç #}
                                <p class="text-muted">–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{% url 'auth:login' %}">–≤–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ <a href="{% url 'users:register' %}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>.</p>
                            {% endif %}
                        </form>
                    {% endif %}
                </div>
                
            </div>
        </div> 
        
        {# üåü –î–û–ë–ê–í–õ–ï–ù–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –¢–û–í–ê–†–ê #}
        <div class="row mt-5">
            <div class="col-12">
                <h3>–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                <p>{{ product.description|linebreaks }}</p>
            </div>
        </div>
        
    </div>
{% endblock content %}

{# –ë–õ–û–ö JAVASCRIPT #}
{% block custom_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('add-to-cart-form');
        const container = document.getElementById('cart-status-container');
        const addButton = document.getElementById('add-btn');

        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); 

                const url = form.action;
                const formData = new FormData(form);
                let originalText = ""; // –û–±—ä—è–≤–ª—è–µ–º –æ–¥–∏–Ω —Ä–∞–∑

                if (addButton) { 
                    originalText = addButton.innerHTML;
                    addButton.innerHTML = '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
                    addButton.disabled = true;
                }
                
                const csrfToken = formData.get('csrfmiddlewaretoken');

                fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –∑–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    container.innerHTML = `
                        <button class="btn btn-success btn-lg w-100" disabled>
                            ‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!
                        </button>
                        <a href="{% url 'orders:cart_detail' %}" class="btn btn-outline-primary btn-lg w-100 mt-2">
                            –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É
                        </a>
                    `;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —à–∞–ø–∫–µ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
                    const cartQuantityDisplay = document.getElementById('cart-quantity-display'); 
                    if (cartQuantityDisplay && data.cart_total_quantity !== undefined) {
                        cartQuantityDisplay.innerHTML = `(${data.cart_total_quantity})`;
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞.');
                    if (addButton) {
                        addButton.innerHTML = originalText;
                        addButton.disabled = false;
                    }
                });
            });
        }
    });
</script>
{% endblock custom_js %}