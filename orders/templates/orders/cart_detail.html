{% extends "base.html" %}
{% load static %}
{% load orders_tags %} {# –ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ç—ç–≥, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –ø–æ–ª—É—á–∏—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É #}

{% block title %}
    –í–∞—à–∞ –ö–æ—Ä–∑–∏–Ω–∞ | –ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω
{% endblock %}

{% block content %}
    <h1>üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h1>
    <hr>
    
    {% if order %}
        <h2>–ó–∞–∫–∞–∑ ‚Ññ{{ order.id }}</h2>
        
        <table class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">–¢–æ–≤–∞—Ä</th>
                    <th scope="col">–¶–µ–Ω–∞</th>
                    <th scope="col">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th scope="col">–°—É–º–º–∞</th>
                    <th scope="col">–£–¥–∞–ª–∏—Ç—å</th>
                </tr>
            </thead>
            <tbody>
                {# –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ OrderItem, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º –∑–∞–∫–∞–∑–æ–º #}
              {% for item in order.items.all %} 
                <tr>
                    {# 1. –ö–û–õ–û–ù–ö–ê "–¢–û–í–ê–†" #}
                    <td>
                        {# üí° –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –±—ã–ª–æ –∫—Ä–∞—Å–∏–≤–µ–µ, –Ω–æ –æ–Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Å—ã–ª–∫–æ–π #}
                        <a href="{% url 'catalog:product_detail' category_slug=item.product.category.slug product_slug=item.product.slug %}">{{ item.product.name }}</a>
                    </td>
                    
                    {# 2. –ö–û–õ–û–ù–ö–ê "–¶–ï–ù–ê" #}
                    <td>{{ item.price|floatformat:2 }} —Ä—É–±.</td>
                    
                    {# 3. –ö–û–õ–û–ù–ö–ê "–ö–û–õ–ò–ß–ï–°–¢–í–û" #}
                    <td>
                        {# –§–æ—Ä–º–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –≤ add_to_cart, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∑–∞—Ç–µ–º –∏–∑–º–µ–Ω–∏–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ UPDATE #}
                        <form action="{% url 'orders:add_to_cart' category_slug=item.product.category.slug product_slug=item.product.slug %}" 
                            method="post" 
                            id="update-form-{{ item.product.slug }}" 
                            class="update-cart-form">
                            {% csrf_token %}
                            

                            <div class="input-group input-group-sm" style="width: 150px;">
        
                                {# –ö–Ω–æ–ø–∫–∞ –ú–ò–ù–£–° #}
                                <button type="button" class="btn btn-outline-danger decrement-btn" data-slug="{{ item.product.slug }}">
                                    <span aria-hidden="true">‚Äì</span>
                                </button>
                                
                                {% with unique_quantity_id='quantity-'|add:item.product.slug %}
                                <input type="number" 
                                        name="quantity" 
                                        value="{{ item.update_quantity_form.quantity.value|default:item.quantity }}" 
                                        class="form-control text-center quantity-input" 
                                        id="{{ unique_quantity_id }}"
                                        min="1" 
                                        required>
                                {% endwith %}
                                
                                {# –ö–Ω–æ–ø–∫–∞ –ü–õ–Æ–° #}
                                <button type="button" class="btn btn-outline-success increment-btn" data-slug="{{ item.product.slug }}">
                                    <span aria-hidden="true">+</span>
                                </button>
                            </div>
                        </form>
                    </td>
                    
                    {# 4. –ö–û–õ–û–ù–ö–ê "–°–£–ú–ú–ê" #}
                    <td id="item-total-{{ item.product.slug }}">{{ item.get_cost|floatformat:2 }} —Ä—É–±.</td> 
                        
                    {# 5. –ö–û–õ–û–ù–ö–ê "–£–î–ê–õ–ò–¢–¨" (–ù–û–í–ê–Ø) #}
                    <td> 
                        <form action="{% url 'orders:remove_from_cart' product_slug=item.product.slug %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger btn-sm" aria-label="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä {{ item.product.name }} –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã">
                                <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                <tr>
                    <td colspan="3" class="text-end"><strong>–ò—Ç–æ–≥–æ:</strong></td>
                    <td id="cart-grand-total-cell"><strong>{{ order.get_total_cost|floatformat:2 }} —Ä—É–±.</strong></td>
                    <td></td> 
                </tr>
                
            </tbody>
        </table>
        <p class="text-end">
            <a href="{% url 'orders:checkout' %}" class="btn btn-success">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
        </p>

    {% else %}
        <p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫–∞ **–ø—É—Å—Ç–∞**.</p>
        <p><a href="{% url 'catalog:catalog_list' %}" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥</a></p>
    {% endif %}

{% endblock %}

{% block custom_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const minQuantity = 1;
        function sendAjaxUpdate(form) {
            const url = form.action;
            const formData = new FormData(form);
            const slug = form.id.replace('update-form-', ''); // –ü–æ–ª—É—á–∞–µ–º SLUG –∏–∑ ID —Ñ–æ—Ä–º—ã

            // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
            const csrfTokenInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
            const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è Django, —á—Ç–æ–±—ã –æ–Ω –∑–Ω–∞–ª, —á—Ç–æ —ç—Ç–æ AJAX-–∑–∞–ø—Ä–æ—Å
                    'X-Requested-With': 'XMLHttpRequest' 
                }
            })
            .then(response => response.json()) // –û–∂–∏–¥–∞–µ–º JSON –æ—Ç–≤–µ—Ç
            .then(data => {
                // 1. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞
                const itemTotalElement = document.getElementById('item-total-' + slug);
                const itemRow = itemTotalElement ? itemTotalElement.closest('tr') : null; // –ù–∞—Ö–æ–¥–∏–º –≤—Å—é —Å—Ç—Ä–æ–∫—É —Ç–æ–≤–∞—Ä–∞
                if (data.item_deleted) {
                    // ‚≠êÔ∏è –ù–û–í–û–ï: –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ = 0), —É–¥–∞–ª—è–µ–º –≤—Å—é —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                    if (itemRow) {
                        itemRow.remove(); 
                    }
                    // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å "–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"
                    if (data.cart_total_quantity === 0) {
                        window.location.reload(); 
                    }
                } 
                else {
                    // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –Ω–µ —É–¥–∞–ª–µ–Ω, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å
                    if (itemTotalElement) {
                        itemTotalElement.innerHTML = `${data.item_cost} —Ä—É–±.`;
                    }
                }

                // 2. –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ—Ä–∑–∏–Ω—ã
                const grandTotalElement = document.getElementById('cart-grand-total-cell');
                if (grandTotalElement) {
                    grandTotalElement.innerHTML = `<strong>${data.cart_total_cost} —Ä—É–±.</strong>`;
                }
                
                // 3. –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —à–∞–ø–∫–µ
                const cartQuantityDisplay = document.getElementById('cart-quantity-display');
                if (cartQuantityDisplay) {
                    if (data.cart_total_quantity > 0) {
                        cartQuantityDisplay.innerHTML = `(${data.cart_total_quantity})`;
                    } else {
                        // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞, —Å–∫—Ä—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ (–∏–ª–∏ –æ—á–∏—â–∞–µ–º)
                        cartQuantityDisplay.innerHTML = '';
                    }
                }
                
                console.log('–ö–æ—Ä–∑–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –ù–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:', data.cart_total_cost);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ AJAX:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã.');
            });
        }

        // ------------------------------------------------------------------
        // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –ü–õ–Æ–°
        // ------------------------------------------------------------------
        document.querySelectorAll('.increment-btn').forEach(button => {
            button.addEventListener('click', () => {
                const slug = button.getAttribute('data-slug');
                const input = document.getElementById('quantity-' + slug);
                if (input) {
                    let currentValue = parseInt(input.value);
                    if (!isNaN(currentValue)) {
                        input.value = currentValue + 1;
                        // ‚≠êÔ∏è –¢–†–ò–ì–ì–ï–† AJAX
                        sendAjaxUpdate(button.closest('form')); 
                    }
                }
            });
        });

        // ------------------------------------------------------------------
        // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –ú–ò–ù–£–°
        // ------------------------------------------------------------------
        document.querySelectorAll('.decrement-btn').forEach(button => {
            button.addEventListener('click', () => {
                const slug = button.getAttribute('data-slug');
                const input = document.getElementById('quantity-' + slug);
                if (input) {
                    let currentValue = parseInt(input.value);
                    if (!isNaN(currentValue) && currentValue > minQuantity) {
                        input.value = currentValue - 1;
                        // ‚≠êÔ∏è –¢–†–ò–ì–ì–ï–† AJAX
                        sendAjaxUpdate(button.closest('form'));
                    }
                }
            });
        });

        // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –ø—Ä–∏ –ø—Ä—è–º–æ–º –≤–≤–æ–¥–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –ø–æ–ª–µ
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ minQuantity
                if (parseInt(this.value) < minQuantity) {
                    this.value = minQuantity;
                }
                // ‚≠êÔ∏è –¢–†–ò–ì–ì–ï–† AJAX
                sendAjaxUpdate(this.closest('form'));
            });
        });
    });
</script>
{% endblock custom_js%}
